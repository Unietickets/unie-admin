<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="/static/css/globals.css" />
    <link rel="stylesheet" href="/static/css/styleguide.css" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;600;700&family=Raleway:wght@700&display=swap" rel="stylesheet">

    <title>UnieTicket - Events</title>
  </head>
  <body>
    <div class="desktop-event-list">
      <nav class="menu-item-sidebar">
        <h1 class="text-wrapper-3">UnieTicket</h1>
        <div class="frame">
          <div class="div">
            <button class="button_create_node" data-bs-toggle="modal" data-bs-target="#createNodeModal" style="{% if user_active.get('context_type') != 'root' %}display: none;{% endif %}">
              <div class="plus"><img class="vector" src="/static/images/sidebar/plus.svg" alt="" /></div>
              <div class="frame-6"><span class="text-wrapper-2">Create node</span></div>
            </button>

           {% if user_active['role'] != 'qr_scanner' %}
            {% set parts = request.path.strip('/').split('/') %}
            {% set section = parts[1] if parts|length > 1 else '' %}
 <div class="sidebar-scroll">
<ul class="frame-2">

  <li class="menu-item">
    <a href="/admin/stats" class="menu-link {% if request.path.startswith('/admin/stats') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/house.svg');" aria-hidden="true"></span>
      <span class="menu-text">Home</span>
    </a>
  </li>

  <li class="menu-item">
    <details class="users-group" {% if section in ['users_admin','clients'] %}open{% endif %}>
      <summary class="menu-link">
        <span class="menu-icon" style="--icon-url:url('/static/images/sidebar/users.svg');" aria-hidden="true"></span>
        <span class="menu-text">Users / Permissions &amp; Roles</span>
      </summary>

      <ul class="submenu">
        <li class="menu-item">
          <a href="/admin/clients" class="menu-link {% if request.path.startswith('/admin/clients') %}is-active{% endif %}">
            <span class="menu-icon" style="--icon-url:url('/static/images/sidebar/key.svg');" aria-hidden="true"></span>
            <span class="menu-text">Clients</span>
          </a>
        </li>

        <li class="menu-item">
          <a href="/admin/users_admin" class="menu-link {% if request.path.startswith('/admin/users_admin') %}is-active{% endif %}">
            <span class="menu-icon" style="--icon-url:url('/static/images/sidebar/calendar-dots.svg');" aria-hidden="true"></span>
            <span class="menu-text">Admin-users &amp; Roles</span>
          </a>
        </li>
      </ul>
    </details>
  </li>

  <li class="menu-item">
    <a href="/admin/events" class="menu-link {% if request.path.startswith('/admin/events') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/calendar-dots.svg');" aria-hidden="true"></span>
      <span class="menu-text">Events</span>
    </a>
  </li>

  <li class="menu-item">
    <a href="/admin/orders" class="menu-link {% if request.path.startswith('/admin/orders') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/shopping-cart-simple.svg');" aria-hidden="true"></span>
      <span class="menu-text">Orders</span>
    </a>
  </li>

<!--  <li class="menu-item">-->
<!--    <a href="/admin/attendees" class="menu-link {% if request.path.startswith('/admin/attendees') %}is-active{% endif %}">-->
<!--      <span class="menu-icon" style="&#45;&#45;icon-url: url('/static/images/sidebar/users.svg');" aria-hidden="true"></span>-->
<!--      <span class="menu-text">Attendees</span>-->
<!--    </a>-->
<!--  </li>-->

  <li class="menu-item">
    <a href="/admin/finance" class="menu-link {% if request.path.startswith('/admin/finance') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/wallet.svg');" aria-hidden="true"></span>
      <span class="menu-text">Finance</span>
    </a>
  </li>

  <li class="menu-item">
    <a href="/admin/support" class="menu-link {% if request.path.startswith('/admin/support') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/chats.svg');" aria-hidden="true"></span>
      <span class="menu-text">Support</span>
    </a>
  </li>

  <li class="menu-item">
    <a href="/admin/team" class="menu-link {% if request.path.startswith('/admin/team') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/key.svg');" aria-hidden="true"></span>
      <span class="menu-text">Team</span>
    </a>
  </li>

  <li class="menu-item" style="padding-bottom: 10px;">
    <a href="/admin/qr_check_in" class="menu-link {% if request.path.startswith('/admin/qr_check_in') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/qr-code.svg');" aria-hidden="true"></span>
      <span class="menu-text">QR Check-in</span>
    </a>
  </li>

</ul>
            {% if user_active['role'] != 'viewer' %}
            <button class="button" aria-label="Create event" onclick="window.location.href='{{ url_for('events.create_event') }}'">
              <div class="plus"><img class="vector" src="/static/images/sidebar/plus.svg" alt="" /></div>
              <div class="frame-6"><span class="text-wrapper-2">Create event</span></div>
            </button>
            {% endif %}
            {% else %}
             <ul class="frame-2">
              <li class="menu-item">
                <a href="/admin/qr_check_in" class="menu-link {% if request.path.startswith('/admin/qr_check_in') %}is-active{% endif %}">
                  <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/qr-code.svg');" aria-hidden="true"></span>
                  <span class="menu-text">QR Check-in</span>
                </a>
              </li>
             </ul>
            {% endif %}
          </div>
          <div class="frame-7">
            <ul>
                <li class="menu-item" style="padding-bottom: 10px;">
    <a href="/admin/help" class="menu-link {% if request.path.startswith('/admin/help') %}is-active{% endif %}">
      <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/question.svg');" aria-hidden="true"></span>
      <span class="menu-text">Help</span>
    </a>
  </li>

                <li class="menu-item">
                <a href="/admin/settings" class="menu-link {% if request.path.startswith('/admin/settings') %}is-active{% endif %}">
                  <span class="menu-icon" style="--icon-url: url('/static/images/sidebar/gear-six.svg');" aria-hidden="true"></span>
                  <span class="menu-text">Settings</span>
                </a>
              </li>

            </ul>
  <div class="sidebar-user">
    <span class="sidebar-user__avatar menu-icon"
          style="--icon-url:url('/static/images/sidebar/avatar.svg');"
          aria-hidden="true"></span>

    <span class="sidebar-user__email">{{ user_active['email_user'] }}</span>

    <button type="button"
            class="icon-btn sidebar-user__logout"
            aria-label="Log out"
            title="Log out"
            onclick="confirmLogout(event)">
      <span class="menu-icon"
            style="--icon-url:url('/static/images/sidebar/exit.svg');"
            aria-hidden="true"></span>
    </button>
  </div>
</div>
          </div>
      </nav>
    </div>
  <div class="modal fade" id="createNodeModal" tabindex="-1" aria-labelledby="createNodeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="createNodeForm" class="modal-content" method="POST" action="/admin/nodes/create">
      <!-- если используете Flask-WTF -->
      {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}

      <div class="modal-header">
        <h5 class="modal-title" id="createNodeModalLabel">Create node</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Organization name (unique) -->
        <div class="mb-3">
          <label class="form-label">Organization name</label>
          <input type="text" class="form-control" id="orgName" name="org_name" required>
          <div class="form-text">Must be unique.</div>
          <div class="invalid-feedback">Please enter a unique organization name.</div>
        </div>

        <!-- Slug (unique) -->
        <div class="mb-3">
          <label class="form-label">Slug</label>
          <input type="text" class="form-control" id="slug" name="slug" required
                 pattern="^[a-z0-9]+(?:-[a-z0-9]+)*$" inputmode="latin"
                 placeholder="my-org-slug">
          <div class="form-text">Lowercase, numbers and hyphens only. Must be unique.</div>
          <div class="invalid-feedback">Slug must be unique and match the format (lowercase, numbers, -).</div>
        </div>

        <!-- Commission (%) int -->
        <div class="mb-3">
          <label class="form-label">Commission (%)</label>
          <div class="input-group">
            <input type="number" class="form-control" id="commission" name="commission"
                   required min="0" max="100" step="1" inputmode="numeric">
            <span class="input-group-text">%</span>
          </div>
          <div class="invalid-feedback">Enter an integer from 0 to 100.</div>
        </div>

        <!-- Main organizer email -->
        <div class="mb-3">
          <label class="form-label">Main organizer email</label>
          <input type="email" class="form-control" id="organizerEmail" name="organizer_email" required>
          <div class="invalid-feedback">Enter a valid email.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Role</label>
          <select class="form-select" id="role" name="role">
              <option value="organizer">Organizer</option>
            <option value="admin">Admin - only root</option>
            <option value="viewer">Viewer</option>
            <option value="qr_scanner">QR-scanner</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Context type</label>
          <input type="text" class="form-control" id="context_type" name="context_type" value="node" readonly>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast "Node has been created" -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="nodeCreatedToast" class="toast align-items-center text-bg-success border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Node has been created</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

  <form id="logout-form" action="/admin/logout" method="POST" style="display:none;">
  {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
</form>

<!-- модалка -->
<div id="logout-overlay" class="logout-overlay" role="dialog" aria-modal="true" aria-labelledby="logout-title">
  <div class="logout-modal">
    <button class="logout-close" type="button" aria-label="Close" onclick="closeLogoutModal()">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="#777" stroke-width="2" stroke-linecap="round"/></svg>
    </button>

    <h3 class="logout-title" id="logout-title">Log out?</h3>
    <p class="logout-desc">Are you sure you want to leave your account? You’ll need to sign in again.</p>

    <div class="logout-actions">
      <button type="button" class="btn btn-accent" onclick="closeLogoutModal()">Cancel</button>
      <button type="button" class="btn btn-danger" onclick="confirmLogoutSubmit()">Log out</button>
    </div>
  </div>
</div>
  </body>

<script>
  const roleSelect = document.getElementById("role");
  const contextInput = document.getElementById("context_type");

  function updateContextType() {
    if (roleSelect.value === "admin") {
      contextInput.value = "root";
      contextInput.textContent = "root";
    } else {
      contextInput.value = "node";
      contextInput.textContent = "node";
    }
  }

  // при загрузке страницы выставляем правильное значение
  updateContextType();

  // при изменении роли обновляем отображение
  roleSelect.addEventListener("change", updateContextType);
</script>
<script>

const slugify = (s) =>
  s.toLowerCase()
   .normalize('NFD').replace(/[\u0300-\u036f]/g,'')   // убрать диакритику
   .replace(/[^a-z0-9]+/g,'-')
   .replace(/^-+|-+$/g,'');

// автослаг из имени (если slug пользователь не трогал)
let userTouchedSlug = false;
const nameEl = document.getElementById('orgName');
const slugEl = document.getElementById('slug');

slugEl.addEventListener('input', () => userTouchedSlug = true);
nameEl.addEventListener('input', () => {
  if (!userTouchedSlug) slugEl.value = slugify(nameEl.value);
});

// простая HTML5-валидация + (опционально) AJAX-проверка уникальности
const form = document.getElementById('createNodeForm');
form.addEventListener('submit', async (e) => {
  // HTML5 validity
  if (!form.checkValidity()) {
    e.preventDefault();
    e.stopPropagation();
    form.classList.add('was-validated');
    return;
  }

  try {
    const [nameChk, slugChk] = await Promise.all([
      fetch(`/api/nodes/check_name?name=${encodeURIComponent(nameEl.value)}`),
      fetch(`/api/nodes/check_slug?slug=${encodeURIComponent(slugEl.value)}`)
    ]);
    const nameJson = await nameChk.json();
    const slugJson = await slugChk.json();

    if (nameJson.exists || slugJson.exists) {
      e.preventDefault();
      e.stopPropagation();

      if (nameJson.exists) {
        nameEl.classList.add('is-invalid');
      } else {
        nameEl.classList.remove('is-invalid');
      }
      if (slugJson.exists) {
        slugEl.classList.add('is-invalid');
      } else {
        slugEl.classList.remove('is-invalid');
      }
      return;
    }
  } catch (err) {
    // если проверка упала — даём форме отправиться обычным путём
    console.warn('Uniq check failed:', err);
  }
});
</script>
<script>
  function confirmLogout(e){
    if(e) e.preventDefault();
    const ov = document.getElementById('logout-overlay');
    ov.style.display = 'flex';
    // фокус внутрь
    setTimeout(() => { ov.querySelector('.btn-danger').focus(); }, 0);
    // esc/клик снаружи
    document.addEventListener('keydown', escHandler);
    ov.addEventListener('mousedown', outsideHandler);
  }

  function closeLogoutModal(){
    const ov = document.getElementById('logout-overlay');
    ov.style.display = 'none';
    document.removeEventListener('keydown', escHandler);
    ov.removeEventListener('mousedown', outsideHandler);
  }

  function escHandler(e){ if(e.key === 'Escape') closeLogoutModal(); }
  function outsideHandler(e){
    const card = document.querySelector('.logout-modal');
    if(!card.contains(e.target)) closeLogoutModal();
  }

  function confirmLogoutSubmit(){
    // если нужен GET: window.location.href = '/logout';
    document.getElementById('logout-form').submit();
  }
</script>
</html>
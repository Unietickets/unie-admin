<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events</title>
    <!-- Подключение Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap"
          rel="stylesheet">
    <!-- Подключение Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style_events.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Raleway:wght=700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body>

<div class="desktop-event-create">
    {% include 'admin/sidebar.html' %}
    <form method="POST" action="/admin/events/create" enctype="multipart/form-data">
        <input type="hidden" name="step" value="step_1">
        <div class="column5">
            <div class="row-view9">

                <button
                        type="button"
                        style="
								background: none;
								border: none;
								padding: 0;
								margin: 0;
								cursor: pointer;
								outline: none;
							  "
                        onclick="window.location.href='/admin/events/cancel'"
                        aria-label="Назад"
                >
                    <img src="/static/images/sidebar/left.svg" alt="Back" draggable="false" style="display: block;"/>
                </button>
                <span class="text6">
							Create new event
						</span>
            </div>
            <div class="column6">
						<span class="text7" style="font-family: Raleway,serif;">
							General info
						</span>

                <div class="column7">
                    <div class="column8">
								<span class="text8" style="font-family: Instrument Sans,serif;">
									Upload event cover
								</span>
                        <div class="view2">
                            <div class="upload-dropzone" id="dropzone">
                                <div id="preview-wrapper">
                                    {% if event_image_url %}
                                    <img id="preview-image-temp"
                                         src="{{ event_image_url }}"
                                         style="display:block; max-width: 320px; max-height: 180px; margin-bottom: 10px; border-radius: 8px;">
                                    {% else %}
                                    <img id="preview-image"
                                         style="display:none; max-width: 320px; max-height: 180px; margin-bottom: 10px; border-radius: 8px;">
                                    {% endif %}
                                </div>
                                <div id="upload-label">
                                    <strong style="font-family: Instrument Sans,serif;
											font-weight: 600;
											font-size: 20px;
											line-height: 120%;
											text-align: center;margin-left: 9%;
											">Upload event cover</strong>
                                    <div style="margin-top:8px; color:#666;font-family: Instrument Sans,serif;
											font-weight: 400;
											font-style: Regular;
											font-size: 14px;
											leading-trim: NONE;
											line-height: 120%;
											letter-spacing: 0%;
											text-align: center;
											">Drag an image here or <span style="font-family: Instrument Sans,serif;
												font-weight: 600;
												font-size: 14px;
												line-height: 120%;
												text-align: center;
												">click</span> to upload<br>JPEG, JPG, PNG · Max 5MB
                                    </div>
                                    <label class="upload-btn" style="font-family: Instrument Sans,serif;"
                                           for="event-cover">Upload your image</label>
                                    <input type="file" id="event-cover" name="event_cover"
                                           accept="image/png,image/jpeg,image/jpg">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="input-block">
                        <label class="input-label" for="event-name">Event name</label>
                        <div class="input-row">
                            <input
                                    class="input-field"
                                    id="event-name"
                                    name="event_name"
                                    type="text"
                                    maxlength="60"
                                    placeholder="Enter event name"
                                    oninput="updateCharCount(this, '#event-name-count', 60)"
                                    autocomplete="off"
                            />
                            <div class="input-info">
                                <span id="event-name-count" class="input-counter">0/60 characters</span>
<!--                                <img src="/static/images/sidebar/CalendarBlank.svg" class="input-calendar"-->
<!--                                     alt="calendar"/>-->
                            </div>
                        </div>
                    </div>
                    <div class="input-block">
                        <label class="input-label" for="event-desc">Description</label>
                        <div class="input-row textarea-row">
    <textarea
            class="input-field textarea-field"
            id="event-desc"
            name="event_desc"
            maxlength="250"
            placeholder="Enter event description"
            oninput="updateCharCount(this, '#event-desc-count', 250)"
            autocomplete="off"
    ></textarea>
                            <div class="input-info">
                                <span id="event-desc-count" class="input-counter">0/250 characters</span>
<!--                                <img src="/static/images/sidebar/CalendarBlank.svg" class="input-calendar"-->
<!--                                     alt="calendar"/>-->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column7">
                  <input type="hidden" id="genres-input" name="genres" value="">
                  <span class="input-label" style="    margin-top: 10%;">Genre</span>

                  <div class="et-genre-input-row" onclick="toggleGenreDropdown()">
                    <div id="genre-tags" class="et-genre-tags"></div>
                    <div class="et-button-row-view">
                      <span id="genre-placeholder" class="et-text9" style="margin-left: -608%; font-family: Instrument Sans, sans-serif;">
                        Select genre
                      </span>
                    </div>
<!--                    <img src="/static/images/sidebar/CalendarBlank.svg" class="et-input-calendar" alt="calendar"/>-->
                  </div>

                  <div id="genre-dropdown" class="et-genre-dropdown">
                    {% for genre in genre_all_list %}
                    <div class="et-genre-option" data-value="{{ genre.id }}" onclick="selectGenre('{{ genre.id }}')">{{ genre.name }}</div>
                    {% endfor %}
                  </div>
                </div>
                <div class="form-actions">
                    <div class="progress-indicator">
                        <span class="step-text">1 of 3</span>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-accent" type="button"
                                onclick="window.location.href='/admin/events/cancel'">Cancel
                        </button>
                        <button class="btn btn-next-step">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function getOptionValue(el) {
  // берём data-value, иначе value, иначе текст как fallback
  return el.dataset.value ?? el.getAttribute('value') ?? el.textContent.trim();
}
function getOptionLabel(el) {
  return el.dataset.label ?? el.textContent.trim();
}
  const genreDropdown = document.getElementById("genre-dropdown");
  const genreTags = document.getElementById("genre-tags");
  const genrePlaceholder = document.getElementById("genre-placeholder");
  let selectedGenres = [];

  function toggleGenreDropdown() {
    // При каждом открытии обновляем дизейблы
    document.querySelectorAll('.et-genre-option').forEach(option => {
        const val = getOptionValue(option);
      if (selectedGenres.includes(val)) {
        option.classList.add('disabled');
        option.onclick = null;
      } else {
        option.classList.remove('disabled');
        option.onclick = function(e) {
          e.stopPropagation();
          selectGenre(val);
        };
      }
    });
    genreDropdown.style.display = genreDropdown.style.display === "block" ? "none" : "block";
  }

  document.querySelector('.et-genre-input-row').onclick = function(e) {
    e.stopPropagation();
    toggleGenreDropdown();
  };

  function selectGenre(genre) {
    if (!selectedGenres.includes(genre)) {
      selectedGenres.push(genre);

      renderSelectedGenres();
    }
    genreDropdown.style.display = "none";
    document.getElementById("genres-input").value = selectedGenres.join(",");
  }

  function renderSelectedGenres() {
    genreTags.innerHTML = "";

    selectedGenres.forEach(g => {
        const option = document.querySelector(`.et-genre-option[data-value="${CSS.escape(g)}"]`);
    const label = option ? getOptionLabel(option) : g;
      const tag = document.createElement("span");
      tag.className = "et-tag";
      tag.textContent = label;

      const remove = document.createElement("span");
      remove.role = 'button';
      remove.className = "remove-genre";
      remove.innerHTML = `
  <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M11.2473 10.6282C11.2879 10.6689 11.3202 10.7171 11.3422 10.7702C11.3642 10.8233 11.3755 10.8803 11.3755 10.9377C11.3755 10.9952 11.3642 11.0522 11.3422 11.1053C11.3202 11.1584 11.2879 11.2066 11.2473 11.2473C11.2066 11.2879 11.1584 11.3202 11.1053 11.3422C11.0522 11.3642 10.9952 11.3755 10.9377 11.3755C10.8803 11.3755 10.8233 11.3642 10.7702 11.3422C10.7171 11.3202 10.6689 11.2879 10.6282 11.2473L7.00024 7.61876L3.37227 11.2473C3.29018 11.3294 3.17884 11.3755 3.06274 11.3755C2.94665 11.3755 2.8353 11.3294 2.75321 11.2473C2.67112 11.1652 2.625 11.0538 2.625 10.9377C2.625 10.8216 2.67112 10.7103 2.75321 10.6282L6.38173 7.00024L2.75321 3.37227C2.67112 3.29018 2.625 3.17884 2.625 3.06274C2.625 2.94665 2.67112 2.8353 2.75321 2.75321C2.8353 2.67112 2.94665 2.625 3.06274 2.625C3.17884 2.625 3.29018 2.67112 3.37227 2.75321L7.00024 6.38173L10.6282 2.75321C10.7103 2.67112 10.8216 2.625 10.9377 2.625C11.0538 2.625 11.1652 2.67112 11.2473 2.75321C11.3294 2.8353 11.3755 2.94665 11.3755 3.06274C11.3755 3.17884 11.3294 3.29018 11.2473 3.37227L7.61876 7.00024L11.2473 10.6282Z" fill="black"/> </svg>`;
      remove.onclick = (e) => {
        e.stopPropagation();
        selectedGenres = selectedGenres.filter(val => val !== g);
        renderSelectedGenres();
      };

      tag.appendChild(remove);
      genreTags.appendChild(tag);
    });
    genrePlaceholder.style.display = selectedGenres.length ? "none" : "inline";
    let input = document.getElementById("genres-input");
    if (!input) {
      input = document.createElement("input");
      input.type = "hidden";
      input.id = "genres-input";
      input.name = "genres";
      genreTags.parentNode.appendChild(input);
    }
    input.value = selectedGenres.join(",");
    // Синхронизируем дизейблы после изменений
    document.querySelectorAll('.et-genre-option').forEach(option => {
         const val = getOptionValue(option);
      if (selectedGenres.includes(val)) {
        option.classList.add('disabled');
        option.onclick = null;
      } else {
        option.classList.remove('disabled');
        option.onclick = function(e) {
          e.stopPropagation();
          selectGenre(val);
        };
      }
    });
  }

  document.addEventListener("click", function(e) {
    if (!e.target.closest('.et-genre-input-wrapper')) {
      genreDropdown.style.display = "none";
    }
  });

  renderSelectedGenres();
</script>
<script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('event-cover');
    const previewImage = document.getElementById('preview-image');
    const previewWrapper = document.getElementById('preview-wrapper');
    const uploadLabel = document.getElementById('upload-label');

    // Drag & Drop Events
    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files && files[0]) {
            fileInput.files = files;
            showPreview(files[0]);
        }
    });
    // Click to trigger input
    dropzone.addEventListener('click', (e) => {
        // Чтобы не срабатывало, если клик по лейблу, кнопке или инпуту
        if (!e.target.closest('label') && !e.target.closest('input')) {
            fileInput.click();
        }
    });

    // Preview function
    function showPreview(file) {
        if (!file.type.startsWith('image/')) {
            previewImage.style.display = 'none';
            return;
        }
        const reader = new FileReader();
        reader.onload = function (e) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Если выбрать через input
    fileInput.addEventListener('change', function () {
        if (fileInput.files && fileInput.files[0]) {
            showPreview(fileInput.files[0]);
        }
    });

    function updateCharCount(input, counterSelector, max) {
        const val = input.value.length;
        document.querySelector(counterSelector).textContent = `${val}/${max} characters`;
    }
</script>
</html>
